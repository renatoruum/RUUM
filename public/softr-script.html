<!-- Cole em Page Settings ▸ Custom Code ▸ Header (ou em um bloco Custom Code) -->
<script>
    /**
     * Tenta pegar o e-mail exposto pelo Softr e, se existir,
     * passa para o iframe.
     */
    function captureAndSendEmail() {
        // Softr injeta as infos de usuário em window.logged_in_user
        const email =
            window.logged_in_user?.softr_user_email ||           // padrão Softr ≥2023
            window.logged_in_user?.EMAIL ||                      // fallback histórico
            null;
        if (!email) return false;            // ainda não carregou – tentaremos de novo
        
        console.log('[RUUM] e-mail capturado:', email);
        
        // Enviar o email para o iframe
        const iframe = document.getElementById('ruum-iframe');
        if (iframe) {
            // IMPORTANTE: Agora carregamos o iframe apenas UMA VEZ com o email
            // Se o iframe ainda não foi inicializado com uma URL (primeira carga)
            if (!iframe._initialized) {
                // Inicializar o iframe apenas uma vez com o email na URL
                const url = new URL(iframe.src);
                url.searchParams.set('email', email); // adicionar como query parameter
                url.hash = email;                     // adicionar como hash
                iframe.src = url.toString();
                iframe._initialized = true;
                console.log('[RUUM] URL do iframe definida:', url.toString());
            }

            // Enviar o email via postMessage (método preferido e que não causa reload)
            try {
                // Usar uma abordagem mais confiável para garantir que o iframe esteja pronto
                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ softrUserEmail: email }, '*');
                    console.log('[RUUM] e-mail enviado para iframe via postMessage:', email);
                }
            } catch (e) {
                console.error('[RUUM] erro ao enviar email via postMessage:', e);
            }
        }
        return true;
    }
    /**
     * Softr carrega o objeto logged_in_user alguns milissegundos
     * depois do DOM. Esta função espera até que o objeto esteja disponível
     * usando uma estratégia de backoff exponencial para ser mais eficiente.
     */
    (function waitForSoftr() {
        // Verificar se já temos o iframe no DOM
        const iframe = document.getElementById('ruum-iframe');
        if (!iframe) {
            console.log('[RUUM] Iframe ainda não encontrado, verificando novamente em 500ms');
            setTimeout(waitForSoftr, 500);
            return;
        }

        // Estratégia de backoff exponencial para verificar o email
        let tries = 0;
        let maxTries = 10; // Limite máximo de tentativas
        let initialDelay = 300; // Delay inicial em ms
        
        function attemptCaptureEmail() {
            // Tenta capturar o email
            const emailCaptured = captureAndSendEmail();
            
            // Se conseguimos capturar o email, terminamos
            if (emailCaptured) {
                console.log('[RUUM] Email capturado com sucesso após', tries, 'tentativas');
                return;
            }
            
            // Se não conseguimos ainda e não atingimos o limite, tenta novamente
            if (++tries < maxTries) {
                const nextDelay = initialDelay * Math.pow(1.5, tries); // Backoff exponencial
                console.log(`[RUUM] Tentativa ${tries}/${maxTries} falhou, próxima tentativa em ${nextDelay}ms`);
                setTimeout(attemptCaptureEmail, nextDelay);
            } else {
                console.log('[RUUM] Limite de tentativas atingido, não foi possível capturar o email');
            }
        }
        
        // Inicia o processo
        attemptCaptureEmail();
    })();

    // Escutar requisições do iframe para obter o email
    window.addEventListener('message', function (event) {
        // Se o iframe está solicitando o email
        if (event.data && event.data.type === 'REQUEST_EMAIL') {
            console.log('[RUUM] Iframe solicitou o email');

            // Buscar o email diretamente do objeto do Softr
            const email = window.logged_in_user?.softr_user_email || window.logged_in_user?.EMAIL;

            // Enviar apenas se temos um email válido
            if (email) {
                // Enviar o email para o iframe imediatamente
                const iframe = document.getElementById('ruum-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ softrUserEmail: email }, '*');
                    console.log('[RUUM] Email enviado para o iframe em resposta à solicitação');
                }
            }
        }
    });
</script>